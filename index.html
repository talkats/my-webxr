<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Model Viewer</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        .status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-width: 300px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="startAR">Start AR</button>
        <input type="file" id="modelUpload" accept=".glb">
        <div>
            <label>Height: <span id="heightValue">1.6</span>m</label>
            <input type="range" id="heightSlider" min="0" max="2" step="0.1" value="1.6">
        </div>
    </div>
    <div id="status" class="status">Initializing...</div>
    <div id="debug"></div>
    <canvas id="renderCanvas" touch-action="none"></canvas>

    <!-- Latest Babylon.js versions -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

    <script>
        class ARModelViewer {
            constructor() {
                this.canvas = document.getElementById("renderCanvas");
                this.engine = new BABYLON.Engine(this.canvas, true);
                this.scene = new BABYLON.Scene(this.engine);
                this.currentModel = null;
                this.xrHelper = null;
                this.isInAR = false;
                
                this.debug("Initializing AR Model Viewer");
                this.init();
            }

            debug(message) {
                console.log(message);
                const debug = document.getElementById("debug");
                const time = new Date().toLocaleTimeString();
                debug.innerHTML += `${time}: ${message}<br>`;
                debug.scrollTop = debug.scrollHeight;
            }

            updateStatus(message) {
                document.getElementById("status").textContent = message;
            }

            async init() {
                try {
                    // Create default camera
                    const camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 1.6, -1.5));
                    camera.setTarget(BABYLON.Vector3.Zero());
                    camera.attachControl(this.canvas, true);

                    // Add lights
                    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), this.scene);
                    light.intensity = 1;

                    // Check WebXR support
                    const xrSupported = await BABYLON.WebXRSessionManager.IsSessionSupportedAsync('immersive-ar');
                    if (!xrSupported) {
                        throw new Error("WebXR AR not supported on this device/browser");
                    }

                    // Initialize WebXR
                    this.xrHelper = await this.scene.createDefaultXRExperienceAsync({
                        uiOptions: {
                            sessionMode: "immersive-ar",
                            referenceSpaceType: "local-floor"
                        }
                    });

                    this.debug("XR Experience created");

                    // Create default sphere
                    this.createDefaultModel();

                    // Setup UI handlers
                    this.setupUIHandlers();

                    // Start rendering
                    this.engine.runRenderLoop(() => {
                        this.scene.render();
                    });

                    this.updateStatus("Ready - Click 'Start AR' to begin");
                } catch (error) {
                    this.debug(`Error during initialization: ${error.message}`);
                    this.updateStatus(`Error: ${error.message}`);
                }
            }

            createDefaultModel() {
                const sphere = BABYLON.MeshBuilder.CreateSphere("sphere", {
                    diameter: 0.2,
                    segments: 32
                }, this.scene);
                
                // Create material for better visibility
                const material = new BABYLON.StandardMaterial("sphereMaterial", this.scene);
                material.diffuseColor = new BABYLON.Color3(1, 0, 0); // Red color
                material.emissiveColor = new BABYLON.Color3(0.2, 0, 0); // Slight glow
                sphere.material = material;

                sphere.position = new BABYLON.Vector3(0, 1.6, -0.5);
                this.currentModel = sphere;
                this.debug("Default sphere created");
            }

            setupUIHandlers() {
                // AR Button
                document.getElementById("startAR").onclick = async () => {
                    try {
                        this.debug("Entering AR...");
                        await this.xrHelper.baseExperience.enterXRAsync("immersive-ar", "local-floor");
                        this.isInAR = true;
                        this.updateStatus("AR session started");
                    } catch (error) {
                        this.debug(`Error entering AR: ${error.message}`);
                        this.updateStatus(`AR Error: ${error.message}`);
                    }
                };

                // Model Upload
                document.getElementById("modelUpload").onchange = async (event) => {
                    if (event.target.files && event.target.files[0]) {
                        try {
                            this.debug("Starting model load...");
                            const file = event.target.files[0];
                            const url = URL.createObjectURL(file);

                            // Remove existing model
                            if (this.currentModel) {
                                this.currentModel.dispose();
                            }

                            this.debug("Loading model...");
                            const result = await BABYLON.SceneLoader.ImportMeshAsync("", url, "", this.scene);
                            
                            this.currentModel = result.meshes[0];
                            const height = parseFloat(document.getElementById("heightSlider").value);
                            this.currentModel.position = new BABYLON.Vector3(0, height, -0.5);

                            // Auto-scale
                            const boundingInfo = this.currentModel.getHierarchyBoundingVectors();
                            const size = boundingInfo.max.subtract(boundingInfo.min);
                            const maxSize = Math.max(size.x, size.y, size.z);
                            const scale = 0.2 / maxSize; // Scale to 20cm
                            this.currentModel.scaling = new BABYLON.Vector3(scale, scale, scale);

                            URL.revokeObjectURL(url);
                            this.debug("Model loaded successfully");
                            this.updateStatus("Model loaded - Ready for AR");
                        } catch (error) {
                            this.debug(`Error loading model: ${error.message}`);
                            this.updateStatus("Error loading model");
                            this.createDefaultModel();
                        }
                    }
                };

                // Height Slider
                document.getElementById("heightSlider").oninput = (event) => {
                    const height = parseFloat(event.target.value);
                    document.getElementById("heightValue").textContent = height.toFixed(1);
                    if (this.currentModel) {
                        this.currentModel.position.y = height;
                    }
                };

                // Handle window resize
                window.addEventListener("resize", () => {
                    this.engine.resize();
                });
            }
        }

        // Initialize when page loads
        window.addEventListener("DOMContentLoaded", () => {
            new ARModelViewer();
        });
    </script>
</body>
</html>
